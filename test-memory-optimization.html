<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory Optimization Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      margin: 10px 0;
      font-family: monospace;
    }
    .results {
      margin-top: 20px;
    }
    .metric {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      margin: 8px 0;
      background: #f9f9f9;
      border-radius: 4px;
      border-left: 4px solid #ccc;
    }
    .metric.good {
      border-left-color: #4caf50;
      background: #f1f8f4;
    }
    .metric.ok {
      border-left-color: #ff9800;
      background: #fff8f0;
    }
    .metric.bad {
      border-left-color: #f44336;
      background: #fef5f5;
    }
    .metric-label {
      font-weight: 500;
      color: #333;
    }
    .metric-value {
      font-family: monospace;
      font-weight: bold;
      color: #2196f3;
    }
    .metric-note {
      font-size: 0.9em;
      color: #666;
      margin-top: 4px;
    }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #1976d2;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .vlist-container {
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    #benchmark-container {
      display: none;
    }
  </style>
</head>
<body>
  <h1></h1>üß™ Memory Optimization Test</h1>

  <div class="container">
    <h2>Test Configuration</h2>
    <p>This test compares memory usage between:</p>
    <ul>
      <li><strong>Baseline:</strong> Default config (copyOnInit: true, enableItemById: true)</li>
      <li><strong>Optimized:</strong> Memory-efficient config (copyOnInit: false, enableItemById: false)</li>
    </ul>
    <p><strong>Note:</strong> Chrome must be started with <code>--enable-precise-memory-info</code> flag for accurate measurements.</p>

    <div>
      <button id="test-10k" onclick="runTest(10000)">Test 10K Items</button>
      <button id="test-100k" onclick="runTest(100000)">Test 100K Items</button>
    </div>
  </div>

  <div class="container">
    <h2>Status</h2>
    <div id="status" class="status">Ready to test...</div>
  </div>

  <div class="container">
    <h2>Results</h2>
    <div id="results" class="results">
      <p>Run a test to see results...</p>
    </div>
  </div>

  <!-- Hidden container for benchmarks -->
  <div id="benchmark-container" class="vlist-container"></div>

  <script type="module">
    import { vlist } from './node_modules/@floor/vlist/dist/vlist.js';

    // Simple template for benchmark items
    const benchmarkTemplate = (item, data) => {
      item.textContent = `Item ${data.id}`;
      item.style.padding = '12px';
      item.style.borderBottom = '1px solid #eee';
    };

    // Generate test items
    function generateItems(count) {
      const items = [];
      for (let i = 0; i < count; i++) {
        items.push({
          id: i,
          name: `Item ${i}`,
          value: Math.random()
        });
      }
      return items;
    }

    // Wait for frames to settle
    function waitFrames(n) {
      return new Promise(resolve => {
        let count = 0;
        function tick() {
          count++;
          if (count >= n) {
            resolve();
          } else {
            requestAnimationFrame(tick);
          }
        }
        requestAnimationFrame(tick);
      });
    }

    // Try to trigger garbage collection
    async function tryGC() {
      if (window.gc) {
        window.gc();
      }
      await waitFrames(5);
    }

    // Get heap memory usage
    function getHeapUsed() {
      if (performance.memory) {
        return performance.memory.usedJSHeapSize;
      }
      return null;
    }

    // Convert bytes to MB
    function bytesToMB(bytes) {
      return bytes / (1024 * 1024);
    }

    // Update status
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    // Measure memory for a specific config
    async function measureMemory(container, itemCount, config) {
      const items = generateItems(itemCount);

      container.innerHTML = '';
      await tryGC();
      await waitFrames(20);

      const baseline = getHeapUsed();

      // Create vlist
      const list = vlist({
        container,
        item: {
          height: 48,
          template: benchmarkTemplate
        },
        items,
        ...config
      }).build();

      // Wait for render to settle
      await waitFrames(20);
      await tryGC();
      await waitFrames(20);

      const afterRender = getHeapUsed();
      const deltaMB = bytesToMB(afterRender - baseline);

      // Cleanup
      list.destroy();
      container.innerHTML = '';
      await tryGC();

      return { baseline, afterRender, deltaMB };
    }

    // Run the complete test
    window.runTest = async function(itemCount) {
      const container = document.getElementById('benchmark-container');
      const resultsDiv = document.getElementById('results');

      // Disable buttons
      document.getElementById('test-10k').disabled = true;
      document.getElementById('test-100k').disabled = true;

      resultsDiv.innerHTML = '<p>Running test...</p>';

      // Check if memory API is available
      if (!performance.memory) {
        resultsDiv.innerHTML = `
          <div class="metric bad">
            <div>
              <div class="metric-label">‚ùå Memory API Not Available</div>
              <div class="metric-note">
                Chrome must be started with --enable-precise-memory-info flag.<br>
                Example: /Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome --enable-precise-memory-info
              </div>
            </div>
          </div>
        `;
        document.getElementById('test-10k').disabled = false;
        document.getElementById('test-100k').disabled = false;
        return;
      }

      try {
        // Test 1: Baseline
        updateStatus(`Testing baseline config (${itemCount.toLocaleString()} items)...`);
        const baselineResult = await measureMemory(container, itemCount, {
          copyOnInit: true,
          enableItemById: true
        });

        // Test 2: Optimized
        updateStatus(`Testing optimized config (${itemCount.toLocaleString()} items)...`);
        const optimizedResult = await measureMemory(container, itemCount, {
          copyOnInit: false,
          enableItemById: false
        });

        // Calculate metrics
        const savings = baselineResult.deltaMB - optimizedResult.deltaMB;
        const savingsPercent = (savings / baselineResult.deltaMB) * 100;

        // Determine ratings
        function getSavingsRating(percent) {
          if (percent >= 50) return 'good';
          if (percent >= 25) return 'ok';
          return 'bad';
        }

        function getMemoryRating(mb) {
          if (mb < 2) return 'good';
          if (mb < 5) return 'ok';
          return 'bad';
        }

        // Display results
        resultsDiv.innerHTML = `
          <h3>Test Results (${itemCount.toLocaleString()} items)</h3>

          <div class="metric ${getMemoryRating(baselineResult.deltaMB)}">
            <div>
              <div class="metric-label">Baseline Memory</div>
              <div class="metric-note">copyOnInit: true, enableItemById: true</div>
            </div>
            <div class="metric-value">${baselineResult.deltaMB.toFixed(2)} MB</div>
          </div>

          <div class="metric ${getMemoryRating(optimizedResult.deltaMB)}">
            <div>
              <div class="metric-label">Optimized Memory</div>
              <div class="metric-note">copyOnInit: false, enableItemById: false</div>
            </div>
            <div class="metric-value">${optimizedResult.deltaMB.toFixed(2)} MB</div>
          </div>

          <div class="metric ${getSavingsRating(savingsPercent)}">
            <div>
              <div class="metric-label">Memory Saved</div>
              <div class="metric-note">Difference between baseline and optimized</div>
            </div>
            <div class="metric-value">${savings.toFixed(2)} MB</div>
          </div>

          <div class="metric ${getSavingsRating(savingsPercent)}">
            <div>
              <div class="metric-label">Reduction</div>
              <div class="metric-note">Percentage improvement</div>
            </div>
            <div class="metric-value">${savingsPercent.toFixed(1)}%</div>
          </div>

          <div class="metric">
            <div>
              <div class="metric-label">Analysis</div>
              <div class="metric-note">
                ${savingsPercent >= 50
                  ? '‚úÖ Excellent reduction! Optimization flags are working as expected.'
                  : savingsPercent >= 25
                  ? '‚ö†Ô∏è Moderate reduction. Some improvement but less than expected.'
                  : '‚ùå Low reduction. Optimization flags may not be working properly.'}
              </div>
            </div>
          </div>
        `;

        updateStatus(`‚úÖ Test complete (${itemCount.toLocaleString()} items)`);

      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="metric bad">
            <div>
              <div class="metric-label">‚ùå Test Failed</div>
              <div class="metric-note">${error.message}</div>
            </div>
          </div>
        `;
        updateStatus('‚ùå Test failed');
      }

      // Re-enable buttons
      document.getElementById('test-10k').disabled = false;
      document.getElementById('test-100k').disabled = false;
    };
  </script>
</body>
</html>
